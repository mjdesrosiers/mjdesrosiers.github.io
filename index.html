<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">

<head>
	<style>
		.grid-container {
			display: grid;
			height: 90vh;
			width: 90vw;
			grid-template-columns: auto auto auto;
			background-color: #2196F3;
			padding: 10px;
		}

		.grid-item {
			background-color: rgba(255, 255, 255, 0.8);
			border: 1px solid rgba(0, 0, 0, 0.8);
			padding: 20px;
			font-size: 90px;
			text-align: center;
			/*vertical-align: middle;*/
			display: flex;
			justify-content: center;
			align-content: center;
			flex-direction: column;
		}
	</style>

	<script>
		if ('serviceWorker' in navigator) {
			navigator.serviceWorker.register('service-worker.js');
		}

		window.addEventListener('DOMContentLoaded', function () {
			const searchParams = new URL(location).searchParams;
			const inputs = Array.from(document.querySelectorAll('input[id]'));

			inputs.forEach(input => {
				if (searchParams.has(input.id)) {
					if (input.type == 'checkbox') {
						input.checked = searchParams.get(input.id);
					} else {
						input.value = searchParams.get(input.id);
						input.blur();
					}
				}
				if (input.type == 'checkbox') {
					input.addEventListener('change', function (event) {
						const newSearchParams = new URL(location).searchParams;
						if (event.target.checked) {
							newSearchParams.set(input.id, event.target.checked);
						} else {
							newSearchParams.delete(input.id);
						}
						history.replaceState({}, '', Array.from(newSearchParams).length ?
							location.pathname + '?' + newSearchParams : location.pathname);
					});
				} else {
					input.addEventListener('input', function (event) {
						const newSearchParams = new URL(location).searchParams;
						if (event.target.value) {
							newSearchParams.set(input.id, event.target.value);
						} else {
							newSearchParams.delete(input.id);
						}
						history.replaceState({}, '', Array.from(newSearchParams).length ?
							location.pathname + '?' + newSearchParams : location.pathname);
					});
				}
			});
		});

		var ChromeSamples = {
			log: function () {
				var line = Array.prototype.slice.call(arguments).map(function (argument) {
					return typeof argument === 'string' ? argument : JSON.stringify(argument);
				}).join(' ');

				//document.querySelector('#log').textContent += line + '\n';
			},

			clearLog: function () {
				document.querySelector('#log').textContent = '';
			},

			setStatus: function (status) {
				document.querySelector('#status').textContent = status;
			},

			setContent: function (newContent) {
				var content = document.querySelector('#content');
				while (content.hasChildNodes()) {
					content.removeChild(content.lastChild);
				}
				content.appendChild(newContent);
			}
		};

		log = ChromeSamples.log;

		function isWebBluetoothEnabled() {
			if (navigator.bluetooth) {
				return true;
			} else {
				ChromeSamples.setStatus('Web Bluetooth API is not available.\n' +
					'Please make sure the "Experimental Web Platform features" flag is enabled.');
				return false;
			}
		}

		function sleep(ms) {
			return new Promise(resolve => setTimeout(resolve, ms));
		}

		function makeID() {
			idBits = [0, 0, 0, 0]
			for (let i = 0; i < 4; i++) {
				idBits[i] = Math.floor(Math.random() * 256);
			}
			return idBits;
		}

		id = makeID();
		device = null;
		server = null;
		service = null;
		characteristic = null;

		async function pairWithBeacon(number) {
			try {
				log('Requesting Bluetooth Device...');

				device = await navigator.bluetooth.requestDevice({
					filters: [{
						name: 'MJD_BLE'
					}],
					optionalServices: ["0000ffff-0000-1000-8000-00805f9b34fb".toLowerCase()] // Required to access service later.
				});


				log('Connecting to GATT Server...');
				server = await device.gatt.connect();

				log('Getting Heart Rate Service...');
				service = await server.getPrimaryService("0000FFFF-0000-1000-8000-00805F9B34FB".toLowerCase());

				log('Getting Heart Rate Control Point Characteristic...');
				characteristic = await service.getCharacteristic("0000FF01-0000-1000-8000-00805F9B34FB".toLowerCase());

				log('> Energy expended has been reset.');
				
			} catch (error) {
				log('Argh! ' + error);
			}
		}

		async function onButtonClick(number) {
			log('Writing Heart Rate Control Point Characteristic...');
			// Writing 1 is the signal to reset energy expended.
			let resetEnergyExpended = Uint8Array.of(1);
			for (let i = 0; i < 1; i++) {
				log("Writing " + i);
				resetEnergyExpended = Uint8Array.of(id[0], id[1], id[2], id[3], number)
				await characteristic.writeValue(resetEnergyExpended);
				// await sleep(1000);
			}
			//await device.gatt.disconnect();
			//log('> Disconnected.');
		}

	</script>
	<h3>Live Output (1)</h3>
	<div id="output" class="output">
		<div id="status"></div>
		<pre id="log"></pre>
	</div>
	<script>
		if (/Chrome\/(\d+\.\d+.\d+.\d+)/.test(navigator.userAgent)) {
			// Let's log a warning if the sample is not supposed to execute on this
			// version of Chrome.
	}
	</script>
	<button>Pair with beacon</button>
	<script>
		document.querySelector('button').addEventListener('click', function () {
			if (isWebBluetoothEnabled()) {
				ChromeSamples.clearLog();
				pairWithBeacon();
			}
		});
	</script>

	<script>
		document.querySelector('button').addEventListener('click', function () {
			if (isWebBluetoothEnabled()) {
				ChromeSamples.clearLog();
				onButtonClick();
			}
		});
	</script>


	<div class="grid-container">
		<div class="grid-item" onClick="onButtonClick(1)">1</div>
		<div class="grid-item" onClick="onButtonClick(2)">2</div>
		<div class="grid-item" onClick="onButtonClick(3)">3</div>
		<div class="grid-item" onClick="onButtonClick(4)">4</div>
		<div class="grid-item" onClick="onButtonClick(5)">5</div>
		<div class="grid-item" onClick="onButtonClick(6)">6</div>
		<div class="grid-item" onClick="onButtonClick(7)">7</div>
		<div class="grid-item" onClick="onButtonClick(8)">8</div>
		<div class="grid-item" onClick="onButtonClick(9)">9</div>
	</div>